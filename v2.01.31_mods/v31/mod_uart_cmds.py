##New debugging commands via UART
##Borrowed some inspiration from @FAGCI code
#Rewrote case routine: Scrubbed 051F & 0521 - Renamed cmd 051F to 05DB - New cmd 0601 & 0603: 0601 is BK4819 ReadRegister(), 0603 is WriteRegister()
#Replaced 0521 call by ReadRegister & WriteRegister @0xE20
#051F already replaced by RAM Reader / ZVEI mods.
#Upgrades max ZVEI sequence length to 128 bytes

##--------------------- do not modify below this line ---------------------------------------------------
import os,sys,struct

print('* Running',os.path.basename(sys.argv[0]),'mod...')
fw =  bytearray(open(sys.argv[1],'rb').read())

if fw[0x0C1C:0x0C1C+6] == b'\x10\xB5\x1D\x48\x1D\x4B':
    print('Rewrite command parser routine to make room...')
    fw[0x0C1C:0x0CA4] = b'\x10\xB5\x1F\x48\x03\x88\x1F\x4A\x99\x18\x31\xD0\x07\x29\x02\xD1\x00\xF0\x6E\xF9\x2E\xE0\x09\x29\x02\xD1\x00\xF0\xA9\xF9\x29\xE0\x13\x29\x02\xD1\x00\xF0\x3C\xF9\x24\xE0\x15\x29\x02\xD1\x00\xF0\x4B\xF9\x1F\xE0\x19\x29\x02\xD1\x00\xF0\x26\xF8\x1A\xE0\x1B\x29\x02\xD1\xFF\xF7\x6B\xFF\x15\xE0\xC7\x29\x02\xD1\x00\xF0\x60\xF8\x10\xE0\xC9\x29\x02\xD1\xFF\xF7\xB1\xFD\x0B\xE0\xED\x29\x02\xD1\x00\xF0\x00\xF9\x06\xE0\xEF\x29\x04\xD1\x00\xF0\xFB\xF8\x01\xE0\xFF\xF7\xA0\xFF\x10\xBD\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x84\x05\x00\x20\xEC\xFA\xFF\xFF'
    print('Make room for longer ZVEI style tones, 128 bytes total...')
    fw[0x0E20:0x0E20+96] = b'\x00'*96		#Freed bytes to 00 (old CMD0521 call)
    print('Insert new CMD_0601 and CMD_0603 routine...')
    fw[0x0E80:0x0E80+60] = b'\x30\xB5\x04\x46\xA3\xB0\x5D\x1C\x20\x79\xEF\x29\x06\xD1\xE1\x88\x0A\xF0\x6E\xF8\x05\x20\x0C\xF0\x63\xF9\x20\x79\x09\xF0\x98\xFD\x6A\x46\x15\x80\x04\x21\x51\x80\x90\x80\x23\x79\x93\x71\x08\x21\x68\x46\x0B\xF0\x15\xF8\x23\xB0\x30\xBD\x00\xBF'
else:
    print('ERROR: Cant find function');sys.exit(1)

open(sys.argv[1],'wb').write(fw)
